<project name="opi-lab-3" default="compile" basedir=".">
    <!-- Include variables and constants -->
    <property file="build.properties" />

    <property file="secret.properties" />

    <!-- Define the classpath for the project -->
    <path id="project.classpath">
        <fileset dir="${lib.dir}">
            <include name="**/*.jar" />
        </fileset>
    </path>

    <!-- Clean the build directory -->
    <target name="clean">
        <delete dir="${build.dir}" />
    </target>
    
    <!-- Create the build directory structure -->
    <target name="init">
        <mkdir dir="${build.dir}" />
        <mkdir dir="${classes.dir}" />
    </target>

    <!-- [default] Compile project -->
    <target name="compile" depends="init">
        <javac srcdir="${src.dir}" destdir="${classes.dir}" includeantruntime="false" classpath="project.classpath">
            <classpath refid="project.classpath" />
            <compilerarg line="-Xlint:unchecked" />
        </javac>
    </target>

    <!-- Build the project and package it into a WAR file -->
    <target name="build" depends="compile">
        <copy todir="${build.dir}/webapp">
            <fileset dir="${webapp.dir}">
                <include name="**/*" />
            </fileset>
        </copy>
        <copy todir="${build.dir}/webapp/WEB-INF/classes">
            <fileset dir="${classes.dir}">
                <include name="**/*" />
            </fileset>
        </copy>
        <copy todir="${build.dir}/webapp/WEB-INF/lib">
            <fileset dir="${lib.dir}">
                <include name="*.jar" />
            </fileset>
        </copy>
        <war destfile="${build.dir}/${war.name}" webxml="${webapp.dir}/WEB-INF/web.xml">
            <manifest>
                <attribute name="Manifest-Version" value="1.0"/>
                <attribute name="Version" value="1.0-SNAPSHOT"/>
            </manifest>
            <fileset dir="${build.dir}/webapp">
                <include name="**/*" />
                <exclude name="**/WEB-INF/web.xml" />
            </fileset>
        </war>
    </target>

    <!-- Validate XML files -->
    <target name="xml">
        <xmlvalidate lenient="true">
            <fileset dir="${basedir}">
                <include name="**/*.xml" />
            </fileset>
        </xmlvalidate>
    </target>

    <!-- Classpath for JUnit tests -->
    <path id="test.classpath">
        <path refid="project.classpath" />
        <pathelement location="${build.dir}/webapp/WEB-INF/classes" />
        <pathelement location="${build.dir}/test-classes" />
        <fileset dir="${lib.dir}">
            <include name="**/*.jar" />
        </fileset>
    </path>

    <!-- Test isInArea function using Junit -->
    <target name="test" depends="build">
        <mkdir dir="${build.dir}/test-classes"/>
        <javac srcdir="${test.dir}" destdir="${build.dir}/test-classes" includeantruntime="false" classpathref="test.classpath">
            <compilerarg line="-Xlint:unchecked"/>
        </javac>
        <mkdir dir="${build.dir}/test-results"/>
        <junitlauncher haltonfailure="true" printsummary="true">
            <classpath>
                <path refid="test.classpath"/>
                <pathelement location="${build.dir}/test-classes"/>
            </classpath>
            <testclasses outputdir="${build.dir}/test-results">
                <fileset dir="${build.dir}/test-classes" includes="**/*Test.class"/>
            </testclasses>
        </junitlauncher>
    </target>

    <!-- Convert native2ascii for localization files -->
    <target name="native2ascii">
        <native2ascii encoding="UTF-8" dest="${build.dir}/webapp/WEB-INF/classes" src="${resources.dir}">
            <include name="**/*.properties" />
        </native2ascii>
    </target>

    <!-- Deploy war to helios -->
    <target name="scp" depends="build">
        <scp todir="${scp.host}" port="${scp.port}" password="${scp.password}" trust="true" >
            <fileset dir="${build.dir}">
                <include name="**/*.war" />
            </fileset>
        </scp>
    </target>

    <!-- Alternative version of the project -->
    <target name="alt">
        <copy todir="${src.tmp}">
            <fileset dir="${src}"/>
        </copy>

        <replace dir="${src}">
            <exclude name="∗∗/∗.jar"/>
            <replacefilter token="${alt.replace.from1}" value="${alt.replace.to1}"/>
        </replace>

        <replace dir="${src}">
            <exclude name="∗∗/∗.jar"/>
            <replacefilter token="${alt.replace.from2}" value="${alt.replace.to2}"/>
        </replace>

        <replace dir="${src}">
            <exclude name="∗∗/∗.jar"/>
            <replacefilter token="${alt.replace.from3}" value="${alt.replace.to3}"/>
        </replace>

        <move todir="${src}">
            <fileset dir="${src}">
                <exclude name="∗∗/∗.jar"/>
            </fileset>
            <filtermapper>
                <replacestring from="${alt.replace.from1}" to="${alt.replace.to1}"/>
                <replacestring from="${alt.replace.from2}" to="${alt.replace.to2}"/>
                <replacestring from="${alt.replace.from3}" to="${alt.replace.to3}"/>
            </filtermapper>
        </move>

        <antcall target="clean"/>
        <antcall target="build"/>

        <delete dir="${src}"/>

        <copy todir="${src}">
            <fileset dir="${src.tmp}"/>
        </copy>

        <delete dir="${src.tmp}"/>

        <!--        <unwar src="${build.dir}/${war.name}" dest="${build.dir}/alt-webapp">-->
        <!--            <patternset>-->
        <!--                <include name="**/*" />-->
        <!--            </patternset>-->
        <!--        </unwar>-->

        <!--        <replace dir="${build.dir}/alt-webapp">-->
        <!--            <replacefilter token="variableName" value="alternativeVariableName" />-->
        <!--            <replacefilter token="ClassName" value="AlternativeClassName" />-->
        <!--        </replace>-->

        <!--        <war destfile="${build.dir}/${war.name}-alt.war" webxml="${build.dir}/alt-webapp/WEB-INF/web.xml">-->
        <!--            <manifest>-->
        <!--                <attribute name="Manifest-Version" value="1.0"/>-->
        <!--                <attribute name="Version" value="1.0-SNAPSHOT-ALT"/>-->
        <!--            </manifest>-->
        <!--            <fileset dir="${build.dir}/alt-webapp">-->
        <!--                <include name="**/*" />-->
        <!--                <exclude name="**/WEB-INF/web.xml" />-->
        <!--            </fileset>-->
        <!--        </war>-->
    </target>

    <!-- Alteernative environment -->
    <target name="env">
        <fail unless="java.home" message="java.home is not set in env.properties" />
        <fail unless="javac.args" message="javac.args is not set in env.properties" />
        <fail unless="vm.args" message="vm.args is not set in env.properties" />

        <javac srcdir="${src.dir}" destdir="${classes.dir}" includeantruntime="false" fork="true" executable="${java.home}/bin/javac">
            <classpath refid="project.classpath" />
            <compilerarg line="${javac.args}" />
        </javac>

        <java fork="true" classname="com.example.Main">
            <jvmarg line="-Djava.home=${java.home} ${vm.args}" />
            <classpath>
                <path refid="project.classpath" />
                <pathelement location="${classes.dir}" />
            </classpath>
        </java>
    </target>

    <!-- Find the last working revision if compilation fails -->
    <target name="history">
        <exec executable="git" outputproperty="current.revision" failonerror="false">
            <arg value="rev-parse"/>
            <arg value="HEAD"/>
        </exec>

        <property name="previous.revision" value="HEAD"/>
        <property name="found.working.revision" value="false"/>

        <taskdef resource="net/sf/antcontrib/antcontrib.properties">
            <classpath>
                <pathelement location="${lib.dir}/ant-contrib.jar"/>
            </classpath>
        </taskdef>

        <foreach list="${previous.revision}" param="revision" target="find-working-revision">
            <param name="revision" value="${previous.revision}"/>
        </foreach>
    </target>

    <target name="find-working-revision">
        <exec executable="git" failonerror="false">
            <arg value="checkout"/>
            <arg value="${revision}"/>
        </exec>

        <trycatch>
            <try>
                <antcall target="compile"/>
                <echo>Found working revision: ${revision}</echo>
                <exec executable="git" output="${build.dir}/diff.txt" failonerror="false">
                    <arg value="diff"/>
                    <arg value="${revision}~1"/>
                    <arg value="${current.revision}"/>
                </exec>
                <exec executable="git" failonerror="false">
                    <arg value="checkout"/>
                    <arg value="${current.revision}"/>
                </exec>
                <fail message="Compilation fixed. Please check diff.txt for changes."/>
            </try>
            <catch>
                <echo>Compilation failed on revision: ${revision}. Checking previous revision...</echo>
            </catch>
        </trycatch>
    </target>


    <!-- Generate MD5 & SHA-1 hash -->
    <target name="generate-checksums">
        <delete file="${checksums.md5.file}" quiet="true"/>
        <delete file="${checksums.sha1.file}" quiet="true"/>

        <checksum algorithm="MD5" fileext=".md5">
            <fileset dir="${build.dir}/webapp"/>
        </checksum>
        <checksum algorithm="SHA1" fileext=".sha1">
            <fileset dir="${build.dir}/webapp"/>
        </checksum>

        <concat destfile="${checksums.md5.file}">
            <fileset dir="${build.dir}/webapp" includes="**/*.md5"/>
        </concat>
        <concat destfile="${checksums.sha1.file}">
            <fileset dir="${build.dir}/webapp" includes="**/*.sha1"/>
        </concat>

        <delete>
            <fileset dir="${build.dir}/webapp" includes="**/*.md5"/>
            <fileset dir="${build.dir}/webapp" includes="**/*.sha1"/>
        </delete>
    </target>

    <!-- Generate docs -->
    <target name="doc" depends="build, generate-checksums">
        <mkdir dir="${build.dir}/javadoc"/>
        <javadoc sourcepath="${src.dir}" destdir="${build.dir}/javadoc" packagenames="*">
            <classpath refid="project.classpath" />
        </javadoc>

        <loadfile property="md5" srcFile="${checksums.md5.file}">
            <filterchain>
                <striplinebreaks/>
            </filterchain>
        </loadfile>
        <loadfile property="sha1" srcFile="${checksums.sha1.file}">
            <filterchain>
                <striplinebreaks/>
            </filterchain>
        </loadfile>

        <manifest file="${build.dir}/webapp/META-INF/MANIFEST.MF" mode="update">
            <attribute name="MD5-Digest" value="${md5}"/>
            <attribute name="SHA1-Digest" value="${sha1}"/>
        </manifest>

        <war destfile="${build.dir}/${war.name}" update="true">
            <fileset dir="${build.dir}/javadoc"/>
        </war>
    </target>

    <!-- Play music on build -->
    <target name="music" depends="build">
        <sound>
            <success source="${lib.dir}/music/success.wav"/>
            <fail source="${lib.dir}/music/failure.wav"/>
        </sound>
    </target>


    <!-- Junit reports -->
    <target name="report" depends="test">
        <tstamp>
        <format property="timestamp" pattern="MM.dd.yyyy_hh:mm:ss_aa"/>
        </tstamp>

        <mkdir dir="${build.dir}/test-results"/>

        <junitreport todir="${build.dir}/test-results">
            <fileset dir="${build.dir}/test-results">
                <include name="TEST-*.xml"/>
            </fileset>
<!--            <report format="frames" todir="${build.dir}/test-reports/html"/>-->
        </junitreport>

        <copy todir="${svn.main_dir}/report">
            <fileset dir="${build.dir}/test-results/"/>
        </copy>

        <exec executable="svn" dir="${svn.main_dir}/report">
            <arg line="add --force ."/>
        </exec>
        <exec executable="svn" dir="${svn.main_dir}">
            <arg line="commit -m 'Auto-test commit'"/>
        </exec>
    </target>

    <!-- Check special classes -->
    <target name="diff">
        <exec executable="git" outputproperty="git.status" failonerror="true">
            <arg value="status"/>
            <arg value="--porcelain"/>
        </exec>

        <loadfile property="classes.to.check" srcFile="${lib.dir}/classes.txt">
            <filterchain>
                <tokenfilter delimoutput=","/>
            </filterchain>
        </loadfile>

        <condition property="changes.detected">
            <and>
                <contains string="${git.status}" substring="M"/>
                <contains string="${git.status}" substring="${classes.to.check}"/>
            </and>
        </condition>

        <antcall target="commit">
            <param name="message" value="Automated commit triggered by changes in specified classes"/>
        </antcall>
    </target>

    <target name="commit" if="changes.detected">
        <exec executable="git" failonerror="true">
            <arg value="add"/>
            <arg value="."/>
        </exec>

        <exec executable="git" failonerror="true">
            <arg value="commit"/>
            <arg value="-m"/>
            <arg value="${message}"/>
        </exec>
    </target>

    <!-- Build 4 prev revisions -->
    <target name="team">
        <exec executable="git" outputproperty="current.revision" failonerror="false">
            <arg value="rev-parse"/>
            <arg value="HEAD"/>
        </exec>

        <property name="revision1" value="${current.revision}~1"/>
        <property name="revision2" value="${current.revision}~2"/>
        <property name="revision3" value="${current.revision}~3"/>
        <property name="revision4" value="${current.revision}~4"/>

        <echo>Building revision: ${revision1}</echo>
        <exec executable="git" failonerror="false">
            <arg value="checkout"/>
            <arg value="${revision1}"/>
        </exec>
        <antcall target="build">
            <param name="war.name" value="${war.name}-${revision1}.war"/>
        </antcall>

        <echo>Building revision: ${revision2}</echo>
        <exec executable="git" failonerror="false">
            <arg value="checkout"/>
            <arg value="${revision2}"/>
        </exec>
        <antcall target="build">
            <param name="war.name" value="${war.name}-${revision2}.war"/>
        </antcall>

        <echo>Building revision: ${revision3}</echo>
        <exec executable="git" failonerror="false">
            <arg value="checkout"/>
            <arg value="${revision3}"/>
        </exec>
        <antcall target="build">
            <param name="war.name" value="${war.name}-${revision3}.war"/>
        </antcall>

        <echo>Building revision: ${revision4}</echo>
        <exec executable="git" failonerror="false">
            <arg value="checkout"/>
            <arg value="${revision4}"/>
        </exec>
        <antcall target="build">
            <param name="war.name" value="${war.name}-${revision4}.war"/>
        </antcall>

        <zip destfile="${build.dir}/team-revisions.zip">
            <fileset dir="${build.dir}">
                <include name="${war.name}-${revision1}.war"/>
                <include name="${war.name}-${revision2}.war"/>
                <include name="${war.name}-${revision3}.war"/>
                <include name="${war.name}-${revision4}.war"/>
            </fileset>
        </zip>
    </target>

</project>
